<!DOCTYPE html>
<html lang="zh-TW"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Diet Patience">
<meta name="theme-color" content="#3b82f6">
<link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/aida-public/AB6AXuDWU3YWOZtS24ARubGFDrBICBqnQoQnKy56zBFXnoMi5tq5qGReqMy4ZOJYI7tldo3VNAyB1R78qQR71ZKQb6BGilN5xOoaXRYsDs3BjrJSxmS2DrjFRZ0j-fQAQ3RjL1dfpPr17X-9ysHPYeM6gHw1tjkv1rsZYb7URKyjWAvSqycJ-bG3XMM98GdEpg2fGUtOghg0n1Lrq5DnbUJPcy8A23bEs-MM4iBCKoWRw0pAKl1EIZP6VnNIx7VA6DYcvxZMlf90RU-X4h4">
<link rel="manifest" href='data:application/manifest+json,{"name":"Diet Patience","short_name":"Patience","start_url":".","display":"standalone","background_color":"#f0f9ff","theme_color":"#3b82f6"}'>

<title>Diet Patience - 忍耐是最高級的紀律</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#3b82f6", "primary-hover": "#2563eb", "secondary": "#0ea5e9",
                        "accent": "#f59e0b", "bg-page": "#f0f9ff", "surface": "#ffffff",
                        "text-main": "#0f172a", "text-light": "#64748b", "danger": "#ef4444"
                    },
                    fontFamily: { "display": ["Manrope", "Noto Sans", "sans-serif"] },
                    boxShadow: { 
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'soft-blue': '0 10px 40px -10px rgba(59, 130, 246, 0.1)', 
                        'glow': '0 0 20px rgba(59, 130, 246, 0.4)',
                    }
                },
            },
        }
    </script>
<style>
        body { min-height: 100dvh; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .material-symbols-outlined.filled { font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24 }
        
        /* 背景層：固定在最底層 */
        #body-bg-layer { 
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            background-size: cover; 
            background-position: center; 
            pointer-events: none; 
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* 毛玻璃效果卡片 */
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hero-bg { position: absolute; inset: 0; background-repeat: no-repeat; transition: all 0.3s ease; }
        .modal-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(10px); }
        
        @keyframes modal-in { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .animate-modal { animation: modal-in 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.28); }
    </style>
  </head>
<body class="font-display antialiased text-text-main">
<div id="body-bg-layer"></div>

<!-- 主容器改為透明，以顯示底層背景圖 -->
<div class="relative flex h-full min-h-screen w-full flex-col overflow-x-hidden max-w-md mx-auto bg-transparent shadow-2xl">
<header class="sticky top-0 z-50 flex items-center bg-white/70 backdrop-blur-lg px-4 py-3 justify-between border-b border-white/20 shadow-sm">
<div class="w-8"></div>
<h2 id="header-title" class="text-text-main text-lg font-extrabold flex-1 text-center tracking-tight">Diet Patience</h2>
<div class="w-8 flex justify-end">
<button onclick="switchTab('settings')" class="text-text-light hover:text-primary transition-colors p-1 rounded-full hover:bg-white/50">
<span class="material-symbols-outlined">settings</span>
</button>
</div>
</header>

<div class="flex-1 overflow-y-auto pb-28">
    <!-- View: Home -->
    <div id="view-home" class="p-4 pt-5 space-y-8">
        <!-- Big Meal Section -->
        <section class="space-y-4">
            <div class="flex justify-between items-end px-1">
                <h3 class="text-xs font-black text-primary uppercase tracking-widest drop-shadow-sm">大餐倒數儀表板</h3>
                <div id="black-star-container-big" class="flex gap-1"></div>
            </div>
            <div class="flex flex-col rounded-[2rem] shadow-glass glass-card overflow-hidden relative">
                <div id="hero-bg-big" class="hero-bg" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDWU3YWOZtS24ARubGFDrBICBqnQoQnKy56zBFXnoMi5tq5qGReqMy4ZOJYI7tldo3VNAyB1R78qQR71ZKQb6BGilN5xOoaXRYsDs3BjrJSxmS2DrjFRZ0j-fQAQ3RjL1dfpPr17X-9ysHPYeM6gHw1tjkv1rsZYb7URKyjWAvSqycJ-bG3XMM98GdEpg2fGUtOghg0n1Lrq5DnbUJPcy8A23bEs-MM4iBCKoWRw0pAKl1EIZP6VnNIx7VA6DYcvxZMlf90RU-X4h4"); background-size: cover; background-position: center;'></div>
                <div class="absolute inset-0 bg-gradient-to-t from-blue-900/80 via-blue-900/20 to-transparent"></div>
                <div class="relative p-7 text-white mt-24">
                    <div class="flex justify-between items-end">
                        <div class="space-y-1">
                            <p class="text-[10px] text-blue-100 font-bold uppercase tracking-wider opacity-90">冷靜期剩餘時間</p>
                            <p id="display-duration-big" class="text-4xl font-black tracking-tighter drop-shadow-md">--</p>
                            <p class="text-[10px] text-blue-100 font-medium bg-black/20 backdrop-blur-sm inline-block px-2 py-0.5 rounded-full mt-2">狀態：<span id="display-tag-big">計算中</span></p>
                        </div>
                        <span id="display-stars-big" class="bg-amber-400 text-blue-900 px-3.5 py-1.5 rounded-full text-xs font-black shadow-glow border border-amber-300">0 ★</span>
                    </div>
                </div>
                <div class="bg-white/60 backdrop-blur-md p-5 space-y-4 relative z-10">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="p-3 bg-white/40 rounded-2xl border border-white/50">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">最近一次花費</p>
                            <p id="display-cost-big" class="text-base font-black text-blue-900">NT$ 0</p>
                        </div>
                        <div class="p-3 bg-white/40 rounded-2xl border border-white/50">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">當前紀律</p>
                            <div id="display-status-big" class="text-[11px] font-bold flex items-center justify-center gap-1">等待中</div>
                        </div>
                    </div>
                    <div class="w-full bg-slate-200/50 h-2 rounded-full overflow-hidden">
                        <div id="display-progress-bar-big" class="bg-gradient-to-r from-primary to-secondary h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="interval-container-big" class="flex gap-2 overflow-x-auto no-scrollbar pb-1"></div>
            <form onsubmit="return false;" class="glass-card p-5 rounded-[2rem] shadow-glass space-y-3">
                <input id="input-big-name" class="w-full bg-white/50 border-white/50 rounded-xl text-xs p-3 focus:ring-2 focus:ring-primary/20 transition-all outline-none" placeholder="大餐名稱 (例如: 和牛燒肉)"/>
                <div class="flex gap-2 text-xs">
                    <input id="input-big-date" class="flex-1 bg-white/50 border-white/50 rounded-xl p-3 outline-none" type="date"/>
                    <input id="input-big-time" class="w-24 bg-white/50 border-white/50 rounded-xl p-3 outline-none" type="time"/>
                </div>
                <div class="flex gap-2">
                    <input id="input-big-price" class="flex-1 bg-white/50 border-white/50 rounded-xl text-sm font-bold p-3 outline-none" placeholder="金額 NT$" type="number"/>
                    <button onclick="tryAddMeal('big')" class="bg-primary hover:bg-primary-hover text-white px-6 rounded-xl text-xs font-bold transition-all active:scale-95 shadow-lg shadow-primary/30">記錄大餐</button>
                </div>
            </form>
        </section>

        <!-- Small Meal Section -->
        <section class="space-y-4">
            <div class="flex justify-between items-end px-1">
                <h3 class="text-xs font-black text-teal-600 uppercase tracking-widest drop-shadow-sm">小餐倒數儀表板</h3>
                <div id="black-star-container-small" class="flex gap-1"></div>
            </div>
            <div class="flex flex-col rounded-[2rem] shadow-glass glass-card overflow-hidden relative">
                <div id="hero-bg-small" class="hero-bg" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDWU3YWOZtS24ARubGFDrBICBqnQoQnKy56zBFXnoMi5tq5qGReqMy4ZOJYI7tldo3VNAyB1R78qQR71ZKQb6BGilN5xOoaXRYsDs3BjrJSxmS2DrjFRZ0j-fQAQ3RjL1dfpPr17X-9ysHPYeM6gHw1tjkv1rsZYb7URKyjWAvSqycJ-bG3XMM98GdEpg2fGUtOghg0n1Lrq5DnbUJPcy8A23bEs-MM4iBCKoWRw0pAKl1EIZP6VnNIx7VA6DYcvxZMlf90RU-X4h4"); background-size: cover; background-position: center; filter: hue-rotate(140deg);'></div>
                <div class="absolute inset-0 bg-gradient-to-t from-teal-900/80 via-teal-900/20 to-transparent"></div>
                <div class="relative p-7 text-white mt-20">
                    <div class="flex justify-between items-end">
                        <div class="space-y-1">
                            <p class="text-[10px] text-teal-50 font-bold uppercase tracking-wider opacity-90">冷靜期剩餘時間</p>
                            <p id="display-duration-small" class="text-4xl font-black tracking-tighter drop-shadow-md">--</p>
                            <p class="text-[10px] text-teal-100 font-bold bg-black/20 backdrop-blur-sm inline-block px-2 py-0.5 rounded-full mt-2">狀態：<span id="display-tag-small">計算中</span></p>
                        </div>
                        <span id="display-stars-small" class="bg-cyan-400 text-teal-900 px-3.5 py-1.5 rounded-full text-xs font-black shadow-glow border border-cyan-300">0 ★</span>
                    </div>
                </div>
                <div class="bg-white/60 backdrop-blur-md p-5 space-y-4 relative z-10">
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="p-3 bg-white/40 rounded-2xl border border-white/50">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">本次花費</p>
                            <p id="display-cost-small" class="text-base font-black text-teal-700">NT$ 0</p>
                        </div>
                        <div class="p-3 bg-white/40 rounded-2xl border border-white/50">
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-wider">克制狀態</p>
                            <div id="display-status-small" class="text-[11px] font-bold flex items-center justify-center gap-1">等待中</div>
                        </div>
                    </div>
                    <div class="w-full bg-slate-200/50 h-2 rounded-full overflow-hidden">
                        <div id="display-progress-bar-small" class="bg-gradient-to-r from-teal-500 to-cyan-400 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="interval-container-small" class="flex gap-2 overflow-x-auto no-scrollbar pb-1"></div>
            <form onsubmit="return false;" class="glass-card p-5 rounded-[2rem] shadow-glass space-y-3">
                <input id="input-small-name" class="w-full bg-white/50 border-white/50 rounded-xl text-xs p-3 focus:ring-2 focus:ring-teal-500/20 transition-all outline-none" placeholder="小餐名稱 (例如: 手搖飲)"/>
                <div class="flex gap-2 text-xs">
                    <input id="input-small-date" class="flex-1 bg-white/50 border-white/50 rounded-xl p-3 outline-none" type="date"/>
                    <input id="input-small-time" class="w-24 bg-white/50 border-white/50 rounded-xl p-3 outline-none" type="time"/>
                </div>
                <div class="flex gap-2">
                    <input id="input-small-price" class="flex-1 bg-white/50 border-white/50 rounded-xl text-sm font-bold p-3 outline-none" placeholder="金額 NT$" type="number"/>
                    <button onclick="tryAddMeal('small')" class="bg-teal-500 hover:bg-teal-600 text-white px-6 rounded-xl text-xs font-bold transition-all active:scale-95 shadow-lg shadow-teal-500/30">記錄小餐</button>
                </div>
            </form>
        </section>
    </div>

    <!-- View: History -->
    <div id="view-history" class="p-4 hidden space-y-6">
        <div><h3 class="text-xs font-black text-slate-400 uppercase mb-3 px-1">大餐歷史</h3><div id="history-list-big" class="space-y-3"></div></div>
        <div><h3 class="text-xs font-black text-slate-400 uppercase mb-3 px-1">小餐歷史</h3><div id="history-list-small" class="space-y-3"></div></div>
    </div>

    <!-- View: Awards -->
    <div id="view-awards" class="p-4 hidden space-y-6">
        <div id="awards-grid" class="grid grid-cols-2 gap-4"></div>
        <div class="glass-card p-5 rounded-[2rem] space-y-4 shadow-glass">
            <h4 id="award-edit-title-label" class="text-xs font-black text-slate-500 uppercase">新增成就獎章</h4>
            <input id="award-new-title" class="w-full bg-white/50 border-white/50 rounded-xl text-xs p-3 outline-none" placeholder="成就名稱"/>
            <div class="grid grid-cols-2 gap-2">
                <select id="award-new-type" class="bg-white/50 border-white/50 rounded-xl text-xs p-3 outline-none">
                    <option value="stars">大餐連擊數</option>
                    <option value="smallStars">小餐連擊數</option>
                    <option value="historyCount">大餐總次數</option>
                    <option value="smallCount">小餐總次數</option>
                </select>
                <input id="award-new-target" type="number" class="bg-white/50 border-white/50 rounded-xl text-xs p-3 outline-none" placeholder="目標數值"/>
            </div>
            <div class="flex gap-2">
                <button id="award-btn-save" onclick="addCustomAward()" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl text-xs">儲存成就</button>
                <button id="award-btn-cancel" onclick="cancelAwardEdit()" class="hidden flex-1 bg-slate-200 text-slate-500 font-bold py-3 rounded-xl text-xs">取消</button>
            </div>
        </div>
    </div>

    <!-- View: Stats -->
    <div id="view-stats" class="p-4 hidden space-y-4">
        <h3 class="text-xs font-black text-slate-400 uppercase mb-2 px-1">自律數據統計</h3>
        <div id="stats-summary" class="space-y-4"></div>
    </div>

    <!-- View: Settings -->
    <div id="view-settings" class="p-4 hidden space-y-6 pb-24">
        <section class="space-y-4">
            <div class="flex justify-between items-center px-1">
                <h4 class="text-sm font-black text-slate-400 uppercase">偏好設定與介面</h4>
                <button onclick="switchTab('home')" class="text-slate-400 p-1"><span class="material-symbols-outlined">close</span></button>
            </div>

            <!-- Global Background & Motivation -->
            <div class="glass-card p-5 rounded-[2rem] space-y-5 shadow-glass">
                <h5 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">主視覺與激勵圖片</h5>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400">激勵圖片 (彈窗顯示)</label>
                        <div class="flex gap-2">
                            <input type="file" id="motivation-img-file" class="hidden" onchange="handleFileUpload(event, 'motivation')"/>
                            <button onclick="document.getElementById('motivation-img-file').click()" class="flex-1 bg-orange-50 text-orange-600 py-3 rounded-xl font-bold text-xs">更換圖片</button>
                            <button onclick="removeImage('motivation')" class="px-4 bg-slate-50 text-slate-400 rounded-xl"><span class="material-symbols-outlined text-sm">image_not_supported</span></button>
                        </div>
                        <div id="motivation-img-preview" class="w-full h-32 bg-slate-100/50 rounded-2xl bg-contain bg-center bg-no-repeat border border-dashed border-slate-300"></div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400">全域背景圖片設定</label>
                        <div class="flex gap-2">
                            <input type="file" id="body-bg-file" class="hidden" onchange="handleFileUpload(event, 'bodyBg')"/>
                            <button onclick="document.getElementById('body-bg-file').click()" class="flex-1 bg-slate-50 text-slate-600 py-3 rounded-xl font-bold text-xs">選擇背景圖</button>
                            <button onclick="removeImage('bodyBg')" class="px-4 bg-slate-50 text-slate-400 rounded-xl"><span class="material-symbols-outlined text-sm">image_not_supported</span></button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-2">
                            <div class="space-y-1">
                                <div class="flex justify-between text-[9px] text-slate-400 uppercase"><span>透明度</span><span id="val-body-op">10</span>%</div>
                                <input id="set-body-op" type="range" class="w-full h-1 accent-primary" oninput="liveUpdateBody()"/>
                            </div>
                            <div class="space-y-1">
                                <div class="flex justify-between text-[9px] text-slate-400 uppercase"><span>縮放</span><span id="val-body-sc">100</span>%</div>
                                <input id="set-body-sc" type="range" min="50" max="200" class="w-full h-1 accent-primary" oninput="liveUpdateBody()"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Visuals -->
            <div class="glass-card p-5 rounded-[2rem] space-y-4 shadow-glass">
                <h5 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">看板深度自訂</h5>
                <div class="space-y-5">
                    <!-- Big Meal -->
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-blue-500 uppercase tracking-tighter">大餐看板設定</p>
                        <div class="flex gap-2">
                            <input type="file" id="hero-big-file" class="hidden" onchange="handleFileUpload(event, 'heroBig')"/>
                            <button onclick="document.getElementById('hero-big-file').click()" class="flex-1 bg-blue-50 text-blue-600 py-2.5 rounded-xl font-bold text-xs">更換圖片</button>
                            <button onclick="removeImage('heroBig')" class="px-3 bg-slate-50 text-slate-300 rounded-xl"><span class="material-symbols-outlined text-sm">delete</span></button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="space-y-1"><p class="text-[8px] text-slate-400 text-center">位移 <span id="val-hb-y">50</span>%</p><input id="set-hb-y" type="range" class="w-full h-1" oninput="liveUpdateHero('big')"/></div>
                            <div class="space-y-1"><p class="text-[8px] text-slate-400 text-center">縮放 <span id="val-hb-sc">100</span>%</p><input id="set-hb-sc" type="range" min="50" max="250" class="w-full h-1" oninput="liveUpdateHero('big')"/></div>
                            <div class="space-y-1"><p class="text-[8px] text-slate-400 text-center">透明 <span id="val-hb-op">100</span>%</p><input id="set-hb-op" type="range" class="w-full h-1" oninput="liveUpdateHero('big')"/></div>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-[2rem] shadow-xl active:scale-95 transition-all">儲存並完成設定</button>
        </section>
    </div>
</div>

<!-- Warning Modal -->
<div id="warning-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6">
    <div class="modal-overlay absolute inset-0"></div>
    <div class="relative bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col items-center p-8 space-y-6 animate-modal">
        <div class="bg-red-50 p-4 rounded-full">
            <span class="material-symbols-outlined text-red-500 text-4xl filled">warning</span>
        </div>
        <div class="text-center space-y-2">
            <h3 class="text-xl font-black text-slate-900">冷靜期尚未結束！</h3>
            <p class="text-xs text-slate-500 leading-relaxed px-4">現在記錄將會獲得一顆 <span class="text-red-600 font-bold">黑星懲罰</span>。為了連擊目標，請再忍耐一下！</p>
        </div>
        <div id="modal-motivate-img" class="w-full aspect-video bg-slate-100 rounded-3xl bg-cover bg-center shadow-inner border border-slate-100"></div>
        <div class="flex flex-col gap-3 w-full pt-2">
            <button onclick="closeModal()" class="w-full bg-primary text-white font-bold py-4 rounded-2xl shadow-lg shadow-primary/20 transition-all active:scale-95">我會繼續忍耐</button>
            <button onclick="confirmMealBreak()" class="w-full bg-white text-red-500 font-bold py-2 text-xs border border-transparent rounded-xl hover:bg-red-50">堅持記錄 (領取黑星)</button>
        </div>
    </div>
</div>

<div class="fixed bottom-0 w-full max-w-md bg-white/80 backdrop-blur-xl border-t border-white/20 flex justify-around items-center h-16 pb-safe">
    <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center text-primary" data-tab="home"><span class="material-symbols-outlined">home</span><span class="text-[10px] font-bold">首頁</span></button>
    <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center text-slate-400" data-tab="history"><span class="material-symbols-outlined">history</span><span class="text-[10px] font-bold">歷史</span></button>
    <button onclick="switchTab('awards')" class="nav-btn flex flex-col items-center text-slate-400" data-tab="awards"><span class="material-symbols-outlined">emoji_events</span><span class="text-[10px] font-bold">成就</span></button>
    <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center text-slate-400" data-tab="stats"><span class="material-symbols-outlined">analytics</span><span class="text-[10px] font-bold">統計</span></button>
</div>
</div>

<script>
    // 固定資料庫名稱，防止更新後資料遺失
    const DB_NAME = 'DIET_PATIENCE_STABLE_STORAGE'; 
    const DB_VER = 1, STORE_NAME = 'app_state';
    
    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VER);
            req.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
            req.onsuccess = (e) => resolve(e.target.result);
            req.onerror = (e) => reject(e.target.error);
        });
    }
    async function dbSet(key, val) {
        try {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).put(val, key);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        } catch(e) { console.error(e); }
    }
    async function dbGet(key) {
        try {
            const db = await openDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const req = tx.objectStore(STORE_NAME).get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        } catch(e) { return null; }
    }

    const DEFAULT_AWARDS = [
        { id: 1, title: '忍耐新手', type: 'historyCount', target: 1, desc: '大餐記錄次數達 1 次', icon: 'restaurant' },
        { id: 2, title: '連擊大師', type: 'stars', target: 3, desc: '大餐連續達成目標 3 次', icon: 'stars' },
        { id: 3, title: '自律之星', type: 'smallStars', target: 3, desc: '小餐連續達成目標 3 次', icon: 'coffee' }
    ];

    let state = {
        lastMeal: null, goalDays: 7, stars: 0, blackStars: 0, history: [],
        lastSmallMeal: null, smallGoalDays: 3, smallStars: 0, smallBlackStars: 0, smallMeals: [],
        bigIntervals: [3, 7, 14, 30], smallIntervals: [1, 3, 7],
        awards: JSON.parse(JSON.stringify(DEFAULT_AWARDS)),
        theme: {
            heroBig: { img: "", op: 100, sc: 100, y: 50 },
            heroSmall: { img: "", op: 60, sc: 100, y: 50 },
            bodyBg: { img: "", op: 10, sc: 100 },
            motivationImg: ""
        }
    };

    let currentPendingMeal = null;
    let editingAwardId = null;

    async function init() {
        const saved = await dbGet('MAIN_STATE');
        if (saved) state = { ...state, ...saved };
        
        // 設定日期輸入框為東八區今天
        const now = new Date();
        const dStr = now.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' }); 
        const tStr = now.toTimeString().slice(0, 5);
        
        ['big', 'small'].forEach(t => { 
            const dEl = document.getElementById(`input-${t}-date`), tEl = document.getElementById(`input-${t}-time`);
            if(dEl) dEl.value = dStr; if(tEl) tEl.value = tStr;
        });
        
        renderIntervals(); applyTheme();
        setInterval(updateDashboard, 1000); 
        updateDashboard();
    }

    async function save() { await dbSet('MAIN_STATE', JSON.parse(JSON.stringify(state))); }

    function renderIntervals() {
        const gen = (t, l, g) => {
            const el = document.getElementById(`interval-container-${t}`);
            if(el) el.innerHTML = l.map(v => `
            <button onclick="setGoal('${t}', ${v})" class="flex-none px-5 py-2 rounded-2xl border text-[10px] font-bold transition-all ${g === v ? 'bg-primary text-white border-primary shadow-lg shadow-primary/20' : 'bg-white text-slate-400 border-slate-100 hover:border-slate-200'}">${v}天</button>`).join('');
        };
        gen('big', state.bigIntervals, state.goalDays); gen('small', state.smallIntervals, state.smallGoalDays);
    }

    function setGoal(t, d) { if(t==='big') state.goalDays=d; else state.smallGoalDays=d; save(); renderIntervals(); updateDashboard(); }

    function tryAddMeal(t) {
        const nEl = document.getElementById(`input-${t}-name`), dEl = document.getElementById(`input-${t}-date`), tiEl = document.getElementById(`input-${t}-time`), pEl = document.getElementById(`input-${t}-price`);
        const n = (nEl && nEl.value) || (t==='big'?'大餐':'小餐');
        const d = dEl ? dEl.value : '', ti = tiEl ? tiEl.value : '', p = (pEl && parseInt(pEl.value)) || 0;
        if (!d || !ti) return;
        
        const ts = new Date(`${d}T${ti}`).getTime();
        const now = Date.now();
        currentPendingMeal = { type: t, name: n, timestamp: ts, price: p, isBreak: false };
        
        const last = t === 'big' ? state.lastMeal : state.lastSmallMeal;
        const targetDays = t === 'big' ? state.goalDays : state.smallGoalDays;
        
        if (last && (now < (last.timestamp + targetDays * 86400000))) {
            currentPendingMeal.isBreak = true;
            showModal();
        } else {
            confirmMealBreak();
        }
    }

    function confirmMealBreak() {
        if(!currentPendingMeal) return;
        const { type, name, timestamp, price, isBreak } = currentPendingMeal;
        const now = Date.now();
        
        if (type === 'big') {
            if(isBreak) { state.stars = 0; state.blackStars++; }
            else { state.stars++; }
            state.lastMeal = { timestamp, price, name, isPenalty: isBreak };
            state.history.unshift({ timestamp, price, name, isPenalty: isBreak });
        } else {
            if(isBreak) { state.smallStars = 0; state.smallBlackStars++; }
            else { state.smallStars++; }
            state.lastSmallMeal = { timestamp, price, name, isPenalty: isBreak };
            state.smallMeals.unshift({ timestamp, price, name, isPenalty: isBreak });
        }
        save(); updateDashboard(); closeModal();
        const pEl = document.getElementById(`input-${type}-price`), nEl = document.getElementById(`input-${type}-name`);
        if(pEl) pEl.value = ""; if(nEl) nEl.value = "";
    }

    function showModal() {
        const modal = document.getElementById('warning-modal');
        const img = document.getElementById('modal-motivate-img');
        if (state.theme.motivationImg) {
            img.style.backgroundImage = `url("${state.theme.motivationImg}")`;
            img.classList.remove('hidden');
        } else {
            img.classList.add('hidden');
        }
        modal.classList.remove('hidden');
    }

    function closeModal() { document.getElementById('warning-modal').classList.add('hidden'); }

    function updateDashboard() {
        const upd = (t, l, g, s, bs) => {
            const durEl = document.getElementById(`display-duration-${t}`), starEl = document.getElementById(`display-stars-${t}`), costEl = document.getElementById(`display-cost-${t}`), barEl = document.getElementById(`display-progress-bar-${t}`), statEl = document.getElementById(`display-status-${t}`), bContainer = document.getElementById(`black-star-container-${t}`), tagEl = document.getElementById(`display-tag-${t}`);
            
            if(!l) { if(durEl) durEl.innerText = "計畫待開始"; return; }
            
            const now = Date.now();
            const targetTime = l.timestamp + (g * 86400000);
            const remaining = targetTime - now;
            
            if (remaining > 0) {
                const days = Math.floor(remaining / 86400000);
                const hours = Math.floor((remaining % 86400000) / 3600000);
                const mins = Math.floor((remaining % 3600000) / 60000);
                
                if(durEl) durEl.innerText = `${days > 0 ? days + '天 ' : ''}${hours}時 ${mins}分`;
                if(tagEl) tagEl.innerText = "冷靜倒數中";
                if(statEl) statEl.innerHTML = `<span class="material-symbols-outlined text-red-500 filled text-lg">local_fire_department</span> 冷靜期`;
            } else {
                if(durEl) durEl.innerText = "已達標！";
                if(tagEl) tagEl.innerText = "冷靜期結束";
                if(statEl) statEl.innerHTML = `<span class="material-symbols-outlined text-green-500 filled text-lg">local_fire_department</span> 加成中`;
            }

            const elapsed = Math.max(0, now - l.timestamp);
            const targetMs = g * 86400000;
            if(starEl) starEl.innerText = `${s} ★`;
            if(costEl) costEl.innerText = `NT$ ${l.price.toLocaleString()}`;
            if(barEl) barEl.style.width = `${Math.min(100, (elapsed / targetMs) * 100)}%`;
            if(bContainer) bContainer.innerHTML = Array(Math.min(bs, 10)).fill('<span class="material-symbols-outlined text-slate-800 text-[14px] filled">stars</span>').join('');
        };
        upd('big', state.lastMeal, state.goalDays, state.stars, state.blackStars);
        upd('small', state.lastSmallMeal, state.smallGoalDays, state.smallStars, state.smallBlackStars);
    }

    function deleteMeal(t, i) {
        if(!confirm('確定刪除此紀錄？')) return;
        if(t==='big') { state.history.splice(i, 1); state.lastMeal = state.history[0] || null; }
        else { state.smallMeals.splice(i, 1); state.lastSmallMeal = state.smallMeals[0] || null; }
        save(); renderHistory(); updateDashboard();
    }

    function renderHistory() {
        const gen = (t, l) => {
            const el = document.getElementById(`history-list-${t}`);
            if(el) el.innerHTML = l.map((m, i) => `
            <div class="glass-card p-4 rounded-2xl flex justify-between items-center shadow-sm relative overflow-hidden">
                ${m.isPenalty ? '<div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>' : ''}
                <div class="pl-2">
                    <p class="text-[9px] font-bold text-slate-400">${new Date(m.timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}</p>
                    <p class="font-bold text-xs flex items-center gap-1">${m.name} ${m.isPenalty ? '<span class="text-[8px] bg-red-100 text-red-600 px-1 rounded">黑星</span>':''}</p>
                </div>
                <div class="flex items-center gap-4">
                    <p class="font-black text-xs ${m.isPenalty?'text-red-500':'text-primary'}">NT$ ${m.price}</p>
                    <button onclick="deleteMeal('${t}', ${i})" class="text-slate-300 hover:text-red-400 transition-colors"><span class="material-symbols-outlined text-base">delete</span></button>
                </div>
            </div>`).join('');
        };
        gen('big', state.history); gen('small', state.smallMeals);
    }

    function renderAwards() {
        const el = document.getElementById('awards-grid');
        if(!el) return;
        el.innerHTML = state.awards.map(a => {
            let val = 0;
            if(a.type === 'stars') val = state.stars;
            else if(a.type === 'smallStars') val = state.smallStars;
            else if(a.type === 'historyCount') val = state.history.length;
            else if(a.type === 'smallCount') val = state.smallMeals.length;
            const cond = val >= a.target;
            return `<div class="glass-card p-5 rounded-3xl text-center relative transition-all ${cond ? 'border-amber-200' : 'opacity-30'}">
                <div class="absolute top-3 right-3 flex gap-1">
                    <button onclick="prepareEditAward(${a.id})" class="text-slate-300 hover:text-primary"><span class="material-symbols-outlined text-xs">edit</span></button>
                    <button onclick="deleteAward(${a.id})" class="text-slate-300 hover:text-red-500"><span class="material-symbols-outlined text-xs">delete</span></button>
                </div>
                <span class="material-symbols-outlined text-3xl ${cond?'text-amber-500 filled':'text-slate-300'}">${a.icon || 'military_tech'}</span>
                <p class="text-[10px] font-black mt-2 text-slate-800">${a.title}</p>
                <p class="text-[8px] text-slate-400 mt-1">${a.desc}</p>
            </div>`;
        }).join('');
    }

    function prepareEditAward(id) {
        editingAwardId = id;
        const a = state.awards.find(ca => ca.id === id);
        document.getElementById('award-new-title').value = a.title;
        document.getElementById('award-new-type').value = a.type;
        document.getElementById('award-new-target').value = a.target;
        document.getElementById('award-edit-title-label').innerText = '正在編輯成就資訊';
        document.getElementById('award-btn-save').innerText = '更新成就';
        document.getElementById('award-btn-cancel').classList.remove('hidden');
        document.getElementById('view-awards').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelAwardEdit() {
        editingAwardId = null;
        document.getElementById('award-new-title').value = "";
        document.getElementById('award-new-target').value = "";
        document.getElementById('award-edit-title-label').innerText = '新增成就獎章';
        document.getElementById('award-btn-save').innerText = '儲存成就';
        document.getElementById('award-btn-cancel').classList.add('hidden');
    }

    function addCustomAward() {
        const t = document.getElementById('award-new-title').value, type = document.getElementById('award-new-type').value, target = parseInt(document.getElementById('award-new-target').value);
        if(!t || isNaN(target)) return;
        const descMap = { 'stars': '大餐連續達成目標', 'smallStars': '小餐連續達成目標', 'historyCount': '大餐記錄次數', 'smallCount': '小餐記錄次數' };
        const desc = `${descMap[type]}達 ${target} 次`;
        if (editingAwardId) {
            const idx = state.awards.findIndex(ca => ca.id === editingAwardId);
            state.awards[idx] = { ...state.awards[idx], title: t, type, target, desc };
            cancelAwardEdit();
        } else {
            state.awards.push({ id: Date.now(), title: t, type, target, desc, icon: 'military_tech' });
        }
        save(); renderAwards();
    }

    function deleteAward(id) { if(confirm('確定刪除此成就？')) { state.awards = state.awards.filter(ca => ca.id !== id); save(); renderAwards(); }}

    function renderStats() {
        const sumB = state.history.reduce((a,b)=>a+b.price,0), countB = state.history.length;
        const sumS = state.smallMeals.reduce((a,b)=>a+b.price,0), countS = state.smallMeals.length;
        const el = document.getElementById('stats-summary');
        if(!el) return;
        el.innerHTML = `
            <div class="grid grid-cols-2 gap-3">
                <div class="p-5 glass-card rounded-[2rem] border-blue-100">
                    <p class="text-[9px] uppercase font-black text-blue-500 tracking-widest">大餐支出</p>
                    <p class="text-xl font-black mt-1">$${sumB.toLocaleString()}</p>
                    <p class="text-[9px] mt-2 font-bold text-slate-400">總計：${countB} 次</p>
                </div>
                <div class="p-5 glass-card rounded-[2rem] border-teal-100">
                    <p class="text-[9px] uppercase font-black text-teal-600 tracking-widest">小餐支出</p>
                    <p class="text-xl font-black mt-1">$${sumS.toLocaleString()}</p>
                    <p class="text-[9px] mt-2 font-bold text-slate-400">總計：${countS} 次</p>
                </div>
            </div>
            <div class="p-6 bg-slate-900 text-white rounded-[2rem] flex justify-between items-center shadow-xl">
                <div><p class="text-[9px] font-black opacity-50 tracking-widest uppercase">總花費累計</p><p class="text-2xl font-black mt-1">$${(sumB+sumS).toLocaleString()}</p></div>
                <div class="text-right"><p class="text-[9px] font-black opacity-50 tracking-widest uppercase">黑星次數</p><p class="text-xl font-black mt-1 text-red-400">${state.blackStars + state.smallBlackStars}</p></div>
            </div>`;
    }

    function handleFileUpload(e, t) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const res = ev.target.result;
            if (t === 'motivation') state.theme.motivationImg = res;
            else if (t === 'bodyBg') state.theme.bodyBg.img = res;
            else state.theme[t].img = res;
            save(); applyTheme();
        };
        reader.readAsDataURL(file);
    }

    function removeImage(type) {
        if(!confirm('確定要移除此照片嗎？')) return;
        if(type === 'motivation') state.theme.motivationImg = "";
        else if(type === 'bodyBg') state.theme.bodyBg.img = "";
        else state.theme[type].img = "";
        save(); applyTheme();
    }

    function applyTheme() {
        const bodyBg = document.getElementById('body-bg-layer'), hBig = document.getElementById('hero-bg-big'), hSmall = document.getElementById('hero-bg-small');
        const b = state.theme.heroBig, s = state.theme.heroSmall, bb = state.theme.bodyBg;
        
        if(bodyBg) {
            bodyBg.style.backgroundImage = bb.img ? `url("${bb.img}")` : 'none';
            bodyBg.style.opacity = bb.op / 100;
            bodyBg.style.transform = `scale(${bb.sc / 100})`;
        }
        
        const defH = "https://lh3.googleusercontent.com/aida-public/AB6AXuDWU3YWOZtS24ARubGFDrBICBqnQoQnKy56zBFXnoMi5tq5qGReqMy4ZOJYI7tldo3VNAyB1R78qQR71ZKQb6BGilN5xOoaXRYsDs3BjrJSxmS2DrjFRZ0j-fQAQ3RjL1dfpPr17X-9ysHPYeM6gHw1tjkv1rsZYb7URKyjWAvSqycJ-bG3XMM98GdEpg2fGUtOghg0n1Lrq5DnbUJPcy8A23bEs-MM4iBCKoWRw0pAKl1EIZP6VnNIx7VA6DYcvxZMlf90RU-X4h4";
        
        if(hBig) {
            hBig.style.backgroundImage = b.img ? `url("${b.img}")` : `url("${defH}")`;
            hBig.style.opacity = b.op/100; hBig.style.backgroundSize = `${b.sc}%`; hBig.style.backgroundPositionY = `${b.y}%`;
        }
        
        if(hSmall) {
            hSmall.style.backgroundImage = s.img ? `url("${s.img}")` : `url("${defH}")`;
            hSmall.style.opacity = s.op/100; hSmall.style.backgroundSize = `${s.sc}%`; hSmall.style.backgroundPositionY = `${s.y}%`;
        }
        
        const mPrev = document.getElementById('motivation-img-preview');
        if(mPrev) mPrev.style.backgroundImage = state.theme.motivationImg ? `url("${state.theme.motivationImg}")` : 'none';
    }

    function liveUpdateBody() {
        state.theme.bodyBg.op = document.getElementById('set-body-op').value;
        state.theme.bodyBg.sc = document.getElementById('set-body-sc').value;
        document.getElementById('val-body-op').innerText = state.theme.bodyBg.op;
        document.getElementById('val-body-sc').innerText = state.theme.bodyBg.sc;
        applyTheme();
    }

    function liveUpdateHero(t) {
        const key = t === 'big' ? 'heroBig' : 'heroSmall', p = t === 'big' ? 'hb' : 'hs';
        state.theme[key].op = document.getElementById(`set-${p}-op`).value;
        state.theme[key].sc = document.getElementById(`set-${p}-sc`).value;
        state.theme[key].y = document.getElementById(`set-${p}-y`).value;
        document.getElementById(`val-${p}-op`).innerText = state.theme[key].op;
        document.getElementById(`val-${p}-sc`).innerText = state.theme[key].sc;
        document.getElementById(`val-${p}-y`).innerText = state.theme[key].y;
        applyTheme();
    }

    function switchTab(t) {
        document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
        const target = document.getElementById(`view-${t}`);
        if(target) target.classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => {
            const isActive = b.dataset.tab === t;
            b.classList.toggle('text-primary', isActive);
            b.classList.toggle('text-slate-400', !isActive);
        });
        if(t==='history') renderHistory(); 
        if(t==='awards') renderAwards(); 
        if(t==='stats') renderStats();
        if(t==='settings') {
            const upd = (p, c) => {
                const op = document.getElementById(`set-${p}-op`), sc = document.getElementById(`set-${p}-sc`), y = document.getElementById(`set-${p}-y`);
                if(op) op.value = c.op; if(sc) sc.value = c.sc; if(y) y.value = c.y;
                const vOp = document.getElementById(`val-${p}-op`), vSc = document.getElementById(`val-${p}-sc`), vY = document.getElementById(`val-${p}-y`);
                if(vOp) vOp.innerText = c.op; if(vSc) vSc.innerText = c.sc; if(vY) vY.innerText = c.y;
            };
            upd('hb', state.theme.heroBig);
            const bo = document.getElementById('set-body-op'), bs = document.getElementById('set-body-sc');
            if(bo) bo.value = state.theme.bodyBg.op; if(bs) bs.value = state.theme.bodyBg.sc;
            const bOpt = document.getElementById('set-big-opts'), sOpt = document.getElementById('set-small-opts');
            if(bOpt) bOpt.value = state.bigIntervals.join(',');
            if(sOpt) sOpt.value = state.smallIntervals.join(',');
        }
    }

    async function saveSettings() {
        const bOpt = document.getElementById('set-big-opts'), sOpt = document.getElementById('set-small-opts');
        if(bOpt) state.bigIntervals = bOpt.value.split(',').map(v=>parseInt(v.trim())).filter(v=>!isNaN(v));
        if(sOpt) state.smallIntervals = sOpt.value.split(',').map(v=>parseInt(v.trim())).filter(v=>!isNaN(v));
        await save(); 
        renderIntervals(); 
        switchTab('home'); 
    }

    window.onload = init;
</script>
</body></html>
